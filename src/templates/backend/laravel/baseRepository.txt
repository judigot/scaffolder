<?php
{{ownerComment}}
namespace App\Repositories;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Collection;
use Illuminate\Contracts\Pagination\LengthAwarePaginator;
use Illuminate\Database\Eloquent\Builder;

abstract class BaseRepository
{
    /**
     * The model being queried.
     *
     * @var Model
     */
    protected $model;

    /**
     * Create a new repository instance.
     *
     * @param Model $model
     */
    public function __construct(Model $model)
    {
        $this->model = $model;
    }

    /**
     * Get all records.
     *
     * @return Collection
     */
    public function getAll(): Collection
    {
        return $this->model->all();
    }

    /**
     * Find a record by ID.
     *
     * @param int $id
     * @return Model|null
     */
    public function findById(int $id): ?Model
    {
        return $this->model->find($id);
    }

    /**
     * Create a new record.
     *
     * @param array $data
     * @return Model
     */
    public function create(array $data): Model
    {
        return $this->model->create($data);
    }

    /**
     * Update a record by ID.
     *
     * @param int $id
     * @param array $data
     * @return bool
     */
    public function update(int $id, array $data): bool
    {
        $record = $this->model->find($id);
        return $record ? $record->update($data) : false;
    }

    /**
     * Delete a record by ID.
     *
     * @param int $id
     * @return bool
     */
    public function delete(int $id): bool
    {
        $record = $this->model->find($id);
        return $record ? $record->delete() : false;
    }

    /**
     * Find a record by specific attributes.
     *
     * @param array $attributes
     * @return Model|null
     */
    public function findByAttributes(array $attributes): ?Model
    {
        return $this->model->where($attributes)->first();
    }

    /**
     * Retrieve paginated records.
     *
     * @param int $perPage
     * @return LengthAwarePaginator
     */
    public function paginate(int $perPage = 15): LengthAwarePaginator
    {
        return $this->model->paginate($perPage);
    }

    /**
     * Search fields for a query with pagination.
     *
     * @param string $query
     * @param array $fields
     * @param int $perPage
     * @return LengthAwarePaginator
     */
    public function search(string $query, array $fields, int $perPage = 15): LengthAwarePaginator
    {
        return $this->model->where(function (Builder $q) use ($query, $fields) {
            foreach ($fields as $field) {
                $q->orWhere($field, 'LIKE', "%$query%");
            }
        })->paginate($perPage);
    }

    /**
     * Count records matching criteria.
     *
     * @param array $criteria
     * @return int
     */
    public function count(array $criteria = []): int
    {
        return $this->model->where($criteria)->count();
    }

    /**
     * Retrieve records with related models.
     *
     * @param array $relations
     * @return Collection
     */
    public function getWithRelations(array $relations): Collection
    {
        return $this->model->with($relations)->get();
    }

    /**
     * Find a record by ID or throw an exception.
     *
     * @param int $id
     * @return Model
     */
    public function findOrFail(int $id): Model
    {
        return $this->model->findOrFail($id);
    }

    /**
     * Update or create a record.
     *
     * @param array $attributes
     * @param array $values
     * @return Model
     */
    public function updateOrCreate(array $attributes, array $values = []): Model
    {
        return $this->model->updateOrCreate($attributes, $values);
    }

    /**
     * Soft delete a record.
     *
     * @param int $id
     * @return bool
     */
    public function softDelete(int $id): bool
    {
        $record = $this->model->find($id);
        return $record ? $record->delete() : false;
    }

    /**
     * Restore a soft-deleted record.
     *
     * @param int $id
     * @return bool
     */
    public function restore(int $id): bool
    {
        $record = $this->model->onlyTrashed()->find($id);
        return $record ? $record->restore() : false;
    }

    /**
     * Update multiple records at once.
     *
     * @param array $criteria
     * @param array $data
     * @return bool
     */
    public function batchUpdate(array $criteria, array $data): bool
    {
        return $this->model->where($criteria)->update($data) > 0;
    }

    /**
     * Check if a record exists.
     *
     * @param array $criteria
     * @return bool
     */
    public function exists(array $criteria): bool
    {
        return $this->model->where($criteria)->exists();
    }

    /**
     * Retrieve values from a column.
     *
     * @param string $column
     * @param string|null $key
     * @return Collection
     */
    public function pluck(string $column, string $key = null): Collection
    {
        return $this->model->pluck($column, $key);
    }

    /**
     * Get or create a record.
     *
     * @param array $attributes
     * @param array $values
     * @return Model
     */
    public function firstOrCreate(array $attributes, array $values = []): Model
    {
        return $this->model->firstOrCreate($attributes, $values);
    }

    /**
     * Get or instantiate a record.
     *
     * @param array $attributes
     * @param array $values
     * @return Model
     */
    public function firstOrNew(array $attributes, array $values = []): Model
    {
        return $this->model->firstOrNew($attributes, $values);
    }

    /**
     * Process records in chunks.
     *
     * @param int $size
     * @param callable $callback
     * @return bool
     */
    public function chunk(int $size, callable $callback): bool
    {
        return $this->model->chunk($size, $callback);
    }

    /**
     * Iterate over each record.
     *
     * @param callable $callback
     * @return bool
     */
    public function each(callable $callback): bool
    {
        return $this->model->each($callback);
    }

    /**
     * Get random records.
     *
     * @param int $count
     * @return Collection
     */
    public function random(int $count = 1): Collection
    {
        return $this->model->inRandomOrder()->limit($count)->get();
    }

    /**
     * Get the latest record.
     *
     * @param string $column
     * @return Model|null
     */
    public function latest(string $column = 'created_at'): ?Model
    {
        return $this->model->latest($column)->first();
    }

    /**
     * Get the oldest record.
     *
     * @param string $column
     * @return Model|null
     */
    public function oldest(string $column = 'created_at'): ?Model
    {
        return $this->model->oldest($column)->first();
    }

    /**
     * Find multiple records by IDs.
     *
     * @param array $ids
     * @return Collection
     */
    public function findMany(array $ids): Collection
    {
        return $this->model->findMany($ids);
    }

    /**
     * Get records where a column value is in a set.
     *
     * @param string $column
     * @param array $values
     * @return Collection
     */
    public function whereIn(string $column, array $values): Collection
    {
        return $this->model->whereIn($column, $values)->get();
    }

    /**
     * Get records where a column value is not in a set.
     *
     * @param string $column
     * @param array $values
     * @return Collection
     */
    public function whereNotIn(string $column, array $values): Collection
    {
        return $this->model->whereNotIn($column, $values)->get();
    }

    /**
     * Get records within a range.
     *
     * @param string $column
     * @param array $range
     * @return Collection
     */
    public function whereBetween(string $column, array $range): Collection
    {
        return $this->model->whereBetween($column, $range)->get();
    }

    /**
     * Get records, including soft-deleted ones.
     *
     * @return Collection
     */
    public function withTrashed(): Collection
    {
        return $this->model->withTrashed()->get();
    }

    /**
     * Get only soft-deleted records.
     *
     * @return Collection
     */
    public function onlyTrashed(): Collection
    {
        return $this->model->onlyTrashed()->get();
    }

    /**
     * Get records without soft-deleted ones.
     *
     * @return Collection
     */
    public function withoutTrashed(): Collection
    {
        return $this->model->withoutTrashed()->get();
    }

    /**
     * Order records by a column.
     *
     * @param string $column
     * @param string $direction
     * @return Collection
     */
    public function orderBy(string $column, string $direction = 'asc'): Collection
    {
        return $this->model->orderBy($column, $direction)->get();
    }

    /**
     * Group records by a column.
     *
     * @param string $column
     * @return Collection
     */
    public function groupBy(string $column): Collection
    {
        return $this->model->groupBy($column)->get();
    }
}
